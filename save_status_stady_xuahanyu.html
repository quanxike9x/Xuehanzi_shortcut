<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>HSK Trainer Web Full v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Arial Unicode MS', sans-serif; background: #f5f5f5; padding: 20px; margin: 0; }
    header { background: #4a6fa5; color: white; padding: 1em; text-align: center; font-size: 1.5em; }
    .container { max-width: 800px; margin: auto; }
    .hanzi { font-size: 60px; font-family: 'SimSun'; text-align: center; margin: 20px 0; }
    input[type="text"] { font-size: 1.1em; padding: 10px; width: 100%; box-sizing: border-box; }
    .btn { padding: 10px 15px; margin: 8px 4px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }
    .accent { background-color: #4a6fa5; color: white; }
    .success { background-color: #28a745; color: white; }
    .danger { background-color: #dc3545; color: white; }
    .secondary { background-color: #6c757d; color: white; }
    #result { font-weight: bold; margin-top: 10px; }
    canvas { display: none; border: 1px solid #ccc; margin-top: 20px; touch-action: none; }
    #canvas-controls { display: none; margin-top: 10px; }
    #wrong-table { display: none; background: white; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #ccc; }
    #wrong-table h3 { margin-top: 0; color: #dc3545; }
    #wrong-table p { margin: 4px 0; }
  </style>
</head>
<body>
<header>HSK Trainer Web Full v3_Quanxike9x</header>
<div class="container">
  <input type="file" id="file-input" accept=".txt" />
  <div id="file-name">Chưa chọn file</div>
  <div class="hanzi" id="hanzi-display">Chưa có từ</div>
  <input type="text" id="answer" placeholder="Nhập nghĩa hoặc Hán tự...">
  <div>
    <button class="btn success" onclick="checkAnswer()">Kiểm tra</button>
    <button class="btn danger" onclick="skipWord()">Bỏ qua</button>
    <button class="btn secondary" onclick="toggleInputMode()">Đổi chế độ</button>
    <button class="btn accent" onclick="showHelp()">Hướng dẫn</button>
    <button class="btn secondary" onclick="toggleNoTone()">Bật/Tắt không dấu</button>
    <button class="btn accent" onclick="startPomodoro()">Pomodoro</button>
    <button class="btn secondary" onclick="toggleCanvas()">Luyện viết</button>
    <button class="btn accent" onclick="lookupHanzi()">Tra Hanzii</button>
  </div>
  <div id="result"></div>
  <div id="pomodoro-timer" style="margin-top: 20px; font-size: 1.5em; display: none;">
    ⏳ Thời gian còn lại: <span id="time-display">25:00</span>
  </div>
  <canvas id="writing-canvas" width="400" height="400"></canvas>
  <div id="canvas-controls">
    <label>Độ dày bút: <input type="range" id="pen-size" min="1" max="15" value="5"></label>
    <button class="btn secondary" onclick="clearCanvas()">Xóa</button>
  </div>
  <div id="wrong-table">
    <h3>Sai rồi hehe!</h3>
    <p><strong>Chữ Hán:</strong> <span id="wt-hanzi"></span></p>
    <p><strong>Pinyin:</strong> <span id="wt-pinyin"></span></p>
    <p><strong>Nghĩa:</strong> <span id="wt-meanings"></span></p>
    <p><strong>Bạn nhập:</strong> <span id="wt-userinput"></span></p>
  </div>

<script>
let words = [], currentWord = null, inputMode = "hanzi", noTone = false;
let canvas = null, ctx = null, penSize = 5, drawing = false;

document.getElementById("file-input").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById("file-name").textContent = file.name;
  const reader = new FileReader();
  reader.onload = function(event) {
    const lines = event.target.result.split("\n");
    words = lines.map(line => {
      const parts = line.trim().split(/\t+|\s{2,}/);
      return parts.length >= 3 ? [parts[0], parts[1], parts.slice(2).join(' ').split(/[,/]/).map(s => s.trim())] : null;
    }).filter(Boolean);
    loadNewWord();
    restoreFullProgress(); // khôi phục nếu có
  };
  reader.readAsText(file);
});

document.getElementById("answer").addEventListener("keydown", function(e) {
  if (e.key === "Enter") checkAnswer();
});

function loadNewWord() {
  if (!words.length) return;
  currentWord = words[Math.floor(Math.random() * words.length)];
  updateWordDisplay();
}

function updateWordDisplay() {
  document.getElementById("hanzi-display").textContent = inputMode === "hanzi" ? currentWord[0] : currentWord[2][0];
  document.getElementById("answer").value = "";
  document.getElementById("result").textContent = "";
  document.getElementById("wrong-table").style.display = "none";
}

function normalize(str) {
  return str.normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/đ/g, "d").toLowerCase();
}

function checkAnswer() {
  saveFullProgress();
  const input = document.getElementById("answer").value.trim();
  if (!input || !currentWord) return;
  let correct = false;
  if (inputMode === "hanzi") {
    const clean = noTone ? normalize(input) : input.toLowerCase();
    correct = currentWord[2].some(m => (noTone ? normalize(m) : m.toLowerCase()) === clean);
  } else {
    correct = currentWord[0] === input;
  }
  if (correct) {
    document.getElementById("result").textContent = "✅ Đúng rồi!";
    document.getElementById("wrong-table").style.display = "none";
    setTimeout(loadNewWord, 1000);
  } else {
    document.getElementById("result").textContent = "❌ Sai rồi!";
    document.getElementById("wt-hanzi").textContent = currentWord[0];
    document.getElementById("wt-pinyin").textContent = currentWord[1];
    document.getElementById("wt-meanings").textContent = currentWord[2].join(", ");
    document.getElementById("wt-userinput").textContent = input;
    document.getElementById("wrong-table").style.display = "block";
  }
}

function skipWord() {
  saveFullProgress();
  loadNewWord();
}

function toggleInputMode() {
  inputMode = inputMode === "hanzi" ? "meaning" : "hanzi";
  updateWordDisplay();
  saveFullProgress();
}

function toggleNoTone() {
  noTone = !noTone;
  alert(noTone ? "Đã bật không dấu" : "Đã tắt không dấu");
  saveFullProgress();
}

function showHelp() {
  alert("1. Tải file .txt: Hán tự\tPinyin\tNghĩa\n2. Nhập nghĩa hoặc chữ Hán tương ứng\n3. Có Pomodoro, luyện viết, lookup Hanzii");
}

let pomoInterval = null;
function startPomodoro() {
  let duration = 25 * 60;
  const timerDiv = document.getElementById("pomodoro-timer");
  const display = document.getElementById("time-display");

  if (pomoInterval) clearInterval(pomoInterval);
  timerDiv.style.display = "block";

  function updateTimer() {
    const minutes = String(Math.floor(duration / 60)).padStart(2, '0');
    const seconds = String(duration % 60).padStart(2, '0');
    display.textContent = `${minutes}:${seconds}`;
    if (duration === 0) {
      clearInterval(pomoInterval);
      alert("⏰ Hết giờ! Nghỉ ngơi 5 phút nhé!");
    }
    duration--;
  }

  updateTimer();
  pomoInterval = setInterval(updateTimer, 1000);
}

function lookupHanzi() {
  if (!currentWord) return;
  const url = "https://hanzii.net/search/word/" + currentWord[0] + "?hl=vi";
  window.open(url, "_blank");
}

function toggleCanvas() {
  canvas = document.getElementById("writing-canvas");
  ctx = canvas.getContext("2d");
  const controls = document.getElementById("canvas-controls");
  const show = canvas.style.display === "none";
  canvas.style.display = controls.style.display = show ? "block" : "none";
  drawGrid();
}

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawGrid();
}

function drawGrid() {
  ctx.strokeStyle = "#ddd";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(0, 200); ctx.lineTo(400, 200);
  ctx.moveTo(200, 0); ctx.lineTo(200, 400);
  ctx.moveTo(0, 0); ctx.lineTo(400, 400);
  ctx.moveTo(400, 0); ctx.lineTo(0, 400);
  ctx.stroke();
}

document.getElementById("pen-size").addEventListener("input", function(e) {
  penSize = parseInt(e.target.value);
});
canvas = document.getElementById("writing-canvas");
canvas.addEventListener("mousedown", e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
canvas.addEventListener("mousemove", e => {
  if (drawing) {
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = penSize;
    ctx.stroke();
  }
});
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);
canvas.addEventListener("touchstart", function(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
});
canvas.addEventListener("touchmove", function(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
  ctx.strokeStyle = "#000";
  ctx.lineWidth = penSize;
  ctx.stroke();
});
canvas.addEventListener("touchend", () => drawing = false);

function saveFullProgress() {
  const progress = {
    currentWord,
    inputMode,
    noTone,
    words
  };
  localStorage.setItem("hsk_full_progress", JSON.stringify(progress));
}

function restoreFullProgress() {
  const saved = localStorage.getItem("hsk_full_progress");
  if (saved) {
    const data = JSON.parse(saved);
    if (data.words) words = data.words;
    if (data.currentWord) currentWord = data.currentWord;
    if (data.inputMode) inputMode = data.inputMode;
    if (typeof data.noTone !== 'undefined') noTone = data.noTone;
    updateWordDisplay();
  }
}
</script>
</div>
</body>
</html>